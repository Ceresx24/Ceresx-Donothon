<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Donothon 2025 — Ultimate Widget</title>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
<style>
  :root{--accent:#9146FF;--bg:rgba(0,0,0,0.8);--text:white;--grad1:#9146FF;--grad2:#00ffcc;--check:#00ff99;--complete:#00ff99}
  body{margin:0;background:transparent;font-family:'Impact',sans-serif;color:var(--text);text-align:center;transition:all 1s}
  .container{padding:40px;border-radius:30px;display:inline-block;background:var(--bg);border:6px solid var(--accent);box-shadow:0 0 60px var(--accent)}
  #timer{font-size:120px;letter-spacing:8px;text-shadow:0 0 30px #000;margin:20px 0}
  .stats{font-size:60px;margin:15px 0}
  .goal-row{background:#222;border-radius:20px;padding:20px;margin:30px 0;position:relative;overflow:hidden;border:4px solid #444;transition:all 1s;opacity:1}
  .goal-row.complete{border-color:var(--complete);background:rgba(0,100,0,0.8)}
  .goal-row.hiding{opacity:0;transform:translateY(-50px);height:0;padding:0;margin:0;border:none}
  .bar-fill{height:70px;background:linear-gradient(90deg,var(--grad1),var(--grad2));border-radius:15px;transition:width 1.5s ease}
  .checkmark{position:absolute;right:30px;top:50%;transform:translateY(-50%);font-size:110px;color:var(--check);opacity:0;transition:opacity 1s}
  .checkmark.show{opacity:1}
  .token-info{position:fixed;bottom:10px;left:10px;background:rgba(0,0,0,0.7);padding:10px;border-radius:10px;font-size:14px;color:#0f0}
</style>
</head>
<body>
<div class="container">
  <div id="timer">00:00:00</div>
  <div class="stats">Raised: $<span id="raised">0.00</span> / $<span id="goal">10,000</span></div>
  <div class="stats">Subs: <span id="subs">0</span> | Highest: <span id="highest">None</span></div>
  <div id="goals"></div>
</div>
<div class="token-info" id="tokenInfo">Read-only • Add ?token=... to contribute</div>

<script>
// CHANGE ONLY THESE TWO LINES
const firebaseConfig = { /* ←← PASTE YOUR FIREBASE CONFIG HERE ←← */ };
const PATH = 'donothon-ultimate-2025-x7k9p2m4q8z3v6n1'; // ←← YOUR SECRET PATH ←←

firebase.initializeApp(firebaseConfig);
const ref = firebase.database().ref(PATH);

const urlParams = new URLSearchParams(window.location.search);
let token = urlParams.get('token') || urlParams.get('sl') || urlParams.get('se') || '';
let platform = token && token.length > 50 ? 'streamelements' : 'streamlabs';

if (token) {
  document.getElementById('tokenInfo').innerHTML = `Connected • ${platform.toUpperCase()} donations active`;
  document.getElementById('tokenInfo').style.background = '#004400';
}

// Apply theme
ref.child('theme').on('value', s => {
  const t = s.val()||{};
  ['accent','bg','text','grad1','grad2','check','complete'].forEach(k => t[k] && document.documentElement.style.setProperty('--'+k, t[k]));
});

let earned = 0, newlyCompleted = new Set();
ref.on('value', s => {
  const d = s.val()||{}, c = d.config||{};
  earned = d.totalEarned||0;

  // Timer
  const secs = d.paused ? (d.pausedAtSeconds||0) : (d.startTime ? Math.floor((Date.now()-d.startTime)/1000)+(d.bonusSeconds||0) : 0);
  const h = String(Math.floor(secs/3600)).padStart(2,'0');
  const m = String(Math.floor((secs%3600/60)).padStart(2,'0');
  const s = String(secs%60).padStart(2,'0');
  document.getElementById('timer').textContent = d.paused ? `[PAUSED] ${h}:${m}:${s}` : `${h}:${m}:${s}`;

  document.getElementById('raised').textContent = earned.toFixed(2);
  document.getElementById('goal').textContent = c.goal||10000;
  document.getElementById('subs').textContent = d.subsCount||0;
  document.getElementById('highest').textContent = d.highestSub||'None';

  // Goals
  const container = document.getElementById('goals');
  container.innerHTML = '';
  if (!c.milestones) return;

  const goals = Object.values(c.milestones).sort((a,b)=>a.amount-b.amount);
  const active = goals.filter(g => earned < g.amount + 5000).slice(0,3);

  active.forEach(g => {
    const complete = earned >= g.amount;
    const pct = Math.min(100, (earned/g.amount)*100);
    const row = document.createElement('div');
    row.className = `goal-row ${complete?'complete':''}`;
    row.dataset.id = g.id;
    row.innerHTML = `
      <div style="font-size:48px;margin-bottom:15px;">$${g.amount.toLocaleString()} → ${g.description}</div>
      <div style="position:relative;">
        <div class="bar-fill" style="width:${pct}%"></div>
        <div class="checkmark ${complete?'show':''}">CHECKMARK</div>
      </div>
    `;
    if (complete) {
      if (!newlyCompleted.has(g.id)) { newlyCompleted.add(g.id); confetti({particleCount:400,spread:120,origin:{y:0.6}}); }
      setTimeout(() => {
        const el = document.querySelector(`[data-id="${g.id}"]`);
        if (el) { el.classList.add('hiding'); setTimeout(()=>el.remove(),1000); }
      }, 20000);
    }
    container.appendChild(row);
  });
});

// Connect friend's token if provided
if (token) {
  const socket = platform === 'streamelements' 
    ? io('wss://realtime.streamelements.com', {transports:['websocket']})
    : io('https://sockets.streamlabs.com', {query:{token}, transports:['websocket']});

  if (platform === 'streamelements') socket.on('connect', () => socket.emit('authenticate', {method:'jwt', token}));

  socket.on('event', e => {
    if (!e.type) return;
    const msgs = Array.isArray(e.message) ? e.message : [e.message || {}];

    ref.transaction(d => {
      if (!d) return d;
      if (!d.startTime) d.startTime = Date.now();

      msgs.forEach(m => {
        if (e.type === 'subscription' || e.type === 'subscriber') {
          const cnt = m.count || 1;
          d.subsCount = (d.subsCount||0) + cnt;
          const tier = m.sub_plan ? parseInt(m.sub_plan)/1000 : 1;
          d.bonusSeconds = (d.bonusSeconds||0) + ((d.config?.timePerSub?.[tier] || 300) * cnt);
          d.totalEarned += (tier===3?24.99:tier===2?9.99:4.99) * cnt;
        }
        if (e.type === 'donation' || e.type === 'tip') {
          const amt = parseFloat(m.amount || m.formatted_amount || 0);
          if (amt>0) { d.totalEarned += amt; d.bonusSeconds += amt * (d.config?.timePerDollar || 60); }
        }
        if (e.type.includes('bits') || e.type.includes('cheer')) {
          const bits = parseInt(m.amount || 0);
          d.bonusSeconds += Math.floor(bits/100) * (d.config?.timePer100Bits || 60);
          d.totalEarned += bits * 0.01;
        }
        if (e.type === 'follow') d.bonusSeconds += d.config?.timePerFollow || 300;
      });
      return d;
    });
  });
}
</script>
</body>
</html>
