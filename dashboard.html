<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ceres Donothon — FINAL DASHBOARD</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@600&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0d0b1c;--card:#14132b;--accent:#a855f7;--accent2:#c17aff;--text:#e2e8f0;--muted:#94a3b8;--success:#00ffaa;--danger:#ff3366;--border:#2d2a57}
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;background-image:radial-gradient(circle at top right,#1a1650 0%,transparent 50%)}
  #loginScreen{background:linear-gradient(135deg,#14132b,#0f0f22);width:420px;padding:50px 40px;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.6);text-align:center;border:1px solid var(--border)}
  #loginScreen h1{font-size:36px;margin-bottom:10px;background:linear-gradient(90deg,#a855f7,#00e5ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  #loginScreen input,#loginScreen button{width:100%;padding:16px;border-radius:14px;margin:10px 0;font-size:18px}
  #loginScreen input{background:#1e1c38;border:none;color:white}
  #loginScreen button{background:var(--accent);border:none;color:white;font-weight:600;cursor:pointer}
  #main{display:none;max-width:1400px;width:100%;padding:30px}
  header h1{font-size:44px;text-align:center;background:linear-gradient(90deg,#a855f7,#00e5ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .live-preview{background:linear-gradient(135deg,#14132b,#0f0f22);padding:32px;border-radius:20px;text-align:center;border:1px solid var(--border);margin-bottom:30px}
  #liveTimer{font-family:'JetBrains Mono',monospace;font-size:92px;background:linear-gradient(90deg,#00ffaa,#00e5ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(360px,1fr));gap:24px}
  .card{background:var(--card);border-radius:16px;padding:28px;border:1px solid var(--border);box-shadow:0 8px 32px rgba(0,0,0,0.4)}
  .card h2{font-size:24px;color:var(--accent);margin-bottom:20px;display:flex;align-items:center;gap:10px}
  .card h2::before{content:"▹"}
  input,button{width:100%;padding:14px 16px;border-radius:12px;border:none;font-size:16px;margin:8px 0;background:#1e1c38;color:var(--text)}
  button{background:var(--accent);color:white;font-weight:600;cursor:pointer;transition:.2s}
  button:hover{background:var(--accent2);transform:translateY(-2px)}
  button.success{background:#00c853} button.danger{background:var(--danger)}
  .goal-item{background:#1e1c38;padding:14px 18px;border-radius:12px;margin:10px 0;display:flex;gap:12px;align-items:center;border-left:4px solid var(--accent)}
  .status{display:inline-block;padding:10px 26px;border-radius:50px;font-weight:600;background:#333;color:#ff9800;margin-top:10px}
  footer{text-align:center;margin-top:50px;color:var(--muted);font-size:14px}
  .small {font-size:14px;color:var(--muted)}
  label {display:block;margin-top:8px;color:var(--muted);font-size:14px}
</style>
</head>
<body>

<div id="loginScreen">
  <h1>CERES DONOTHON</h1>
  <p>Control Panel Access</p>
  <input type="password" id="pw" placeholder="Enter password">
  <button id="unlockBtn">UNLOCK DASHBOARD</button>
</div>

<div id="main">
  <header><h1>Ceres Donothon Control Panel</h1></header>
  
  <div class="live-preview">
    <h2 style="color:#fff;margin:0">Donothon by <span id="liveName">Ceres</span></h2>
    <div id="liveTimer">03:00:00</div>
    <div style="font-size:28px;margin:10px 0">Raised: $<span id="liveRaised">0.00</span> • Subs: <span id="liveSubs">0</span> • Bits: <span id="liveBits">0</span></div>
    <div class="status" id="status">STOPPED</div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Timer Control</h2>
      <button class="success" style="padding:20px;font-size:20px" onclick="startTimer()">START 3-HOUR TIMER</button>
      <button id="pauseBtn" style="margin:15px 0;padding:16px;font-size:18px" onclick="togglePause()">PAUSE</button>
      <button class="danger" onclick="if(confirm('Reset EVERYTHING?'))resetAll()">RESET ALL DATA</button>
      <button style="margin-top:20px;background:#ff9800;color:white" onclick="ref.child('justHit').set(true)">TEST 5-SEC CELEBRATION</button>
    </div>

    <div class="card">
      <h2>Manual Add</h2>
      <input type="number" step="0.01" id="addMoney" placeholder="Donation amount ($)">
      <input type="number" id="addMinutes" placeholder="Extra minutes">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
        <button onclick="addMoneyAndTime()">Add $ + Time</button>
        <button onclick="addMoneyOnly()">Add $ Only (+1min/$)</button>
      </div>
      <button style="margin-top:10px" onclick="addTimeOnly()">Add Time Only</button>
    </div>

    <div class="card">
      <h2>Appearance</h2>
      <input id="streamerName" placeholder="Streamer name">
      <button style="margin-top:8px" onclick="updateName()">Update Name</button>
      <label style="margin-top:20px">Goal Box Scale: <strong><span id="scaleValue">100</span>%</strong></label>
      <input type="range" min="50" max="200" value="100" id="goalScale" oninput="document.getElementById('scaleValue').textContent=this.value">
      <button onclick="saveGoalScale()">Apply Scale</button>
    </div>
  </div>

  <div class="card" style="margin-top:30px">
    <h2>Milestones</h2>
    <div id="goalList"></div>
    <div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap">
      <input placeholder="Amount $" id="newAmt" style="width:150px">
      <input placeholder="Description" id="newDesc" style="flex:1">
      <button onclick="addGoal()">+ Add Milestone</button>
    </div>
  </div>

  <div class="grid" style="margin-top:20px">
    <div class="card">
      <h2>Colors & Effects</h2>
      <label>Accent</label><input type="color" id="ac" value="#a855f7" onchange="save('accent',this.value)">
      <label>Text</label><input type="color" id="txt" value="#ffffff" onchange="save('text',this.value)">
      <label>Gradient Start</label><input type="color" id="g1" value="#a855f7" onchange="save('grad1',this.value)">
      <label>Gradient End</label><input type="color" id="g2" value="#00e5ff" onchange="save('grad2',this.value)">
      <label>Goal Hit Glow</label><input type="color" id="goalHitColor" value="#00ffaa" onchange="save('goalHitColor',this.value)">
      <label>Timer Hit Glow</label><input type="color" id="timerHitColor" value="#00ffaa" onchange="save('timerHitColor',this.value)">
      <button style="margin-top:15px" onclick="saveColors()">Save All Colors</button>
    </div>

    <div class="card">
      <h2>Visibility & Sound</h2>
      <label><input type="checkbox" id="hideSubs"> Hide Subs/Bits Line</label>
      <label><input type="checkbox" id="hideGoal"> Hide Total Goal Text</label>
      <label><input type="checkbox" id="hideFooter"> Hide Footer Name</label>
      <label><input type="checkbox" id="confettiOn" checked> Enable Confetti</label>
      <label class="small">Celebration Sound (empty = RuneScape)</label>
      <input id="soundUrl" placeholder="https://...">
      <button onclick="ref.child('theme/sound').set(document.getElementById('soundUrl').value.trim()||null)">Save Sound</button>
      <label>Sound Volume</label>
      <input type="range" min="0" max="100" value="100" id="soundVol" oninput="ref.child('theme/soundVolume').set(this.value)">
    </div>
  </div>

  <footer>Ceres Donothon Timer • Professional Edition • 2025</footer>
</div>

<script>
/* CONFIG */
const PATH = 'donothon-ultimate-2025-x7k9p2m4q8z3v6n1';
const PASSWORDS = ['Rin125','125','Rinmod125'];
firebase.initializeApp({apiKey:"AIzaSyBFQFPo85fIpaHWl3Kr0PZ6WIm5B6WVusA",authDomain:"ceres-donothon-timer.firebaseapp.com",databaseURL:"https://ceres-donothon-timer-default-rtdb.firebaseio.com",projectId:"ceres-donothon-timer"});
const ref = firebase.database().ref(PATH);

/* Local cache updated by the single Firebase listener */
let stateCache = {};

/* --- LOGIN --- */
const pwInput = document.getElementById('pw');
document.getElementById('unlockBtn').addEventListener('click', login);
pwInput.addEventListener('keydown', e => { if (e.key === 'Enter') login(); });

function login() {
  const val = pwInput.value.trim();
  if (PASSWORDS.includes(val)) {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('main').style.display = 'block';
    initDashboard();
  } else {
    alert('Wrong password');
  }
}

/* --- INIT --- */
function initDashboard() {
  // Central firebase listener - single source of truth
  ref.on('value', snap => {
    stateCache = snap.val() || {};
    // Update immediate UI elements from cache
    document.getElementById('status').textContent = stateCache.paused ? 'PAUSED' : (stateCache.endTime ? 'LIVE' : 'STOPPED');
    document.getElementById('pauseBtn').textContent = stateCache.paused ? 'RESUME' : 'PAUSE';
    document.getElementById('liveRaised').textContent = (stateCache.totalEarned||0).toFixed(2);
    document.getElementById('liveSubs').textContent = stateCache.subsCount||0;
    document.getElementById('liveBits').textContent = stateCache.bitsCount||0;
    // streamer name
    document.getElementById('liveName').textContent = (stateCache.settings && stateCache.settings.streamerName) ? stateCache.settings.streamerName : 'Ceres';
    // render theme and goals
    loadTheme(stateCache.theme || {});
    renderGoals({ val: () => (stateCache.config && stateCache.config.milestones) ? stateCache.config.milestones : {} });
    // sound volume -> set range control if present
    if (stateCache.theme && typeof stateCache.theme.soundVolume !== 'undefined') {
      const sv = document.getElementById('soundVol');
      if (sv) sv.value = stateCache.theme.soundVolume;
    }
  });

  // update display every second from local cache (no network calls)
  setInterval(updateLive, 1000);
}

/* --- TIMER DISPLAY LOGIC --- */
function updateLive() {
  const d = stateCache || {};
  let leftSeconds = 0;

  if (d.paused) {
    // When paused, we store pausedRemaining in milliseconds; convert to seconds
    leftSeconds = Math.max(0, Math.ceil((d.pausedRemaining || 0) / 1000));
  } else if (d.endTime) {
    const bonusMs = (d.bonusSeconds || 0) * 1000;
    const effectiveEnd = (d.endTime || 0) + bonusMs;
    leftSeconds = Math.max(0, Math.ceil((effectiveEnd - Date.now()) / 1000));
  } else {
    leftSeconds = 0;
  }

  const h = String(Math.floor(leftSeconds / 3600)).padStart(2,'0');
  const m = String(Math.floor((leftSeconds % 3600) / 60)).padStart(2,'0');
  const s = String(leftSeconds % 60).padStart(2,'0');
  document.getElementById('liveTimer').textContent = `${h}:${m}:${s}`;
}

/* --- PAUSE / RESUME (robust) --- */
/*
State scheme:
- endTime: timestamp (ms) when timer should finish (does NOT include pausedRemaining)
- paused: boolean
- pausedRemaining: milliseconds remaining when paused (only present when paused)
- bonusSeconds: seconds added to the endTime when running (persisted)
*/
function togglePause() {
  // read latest local cache for logic decisions; all writes are via transactions/updates
  const d = stateCache || {};

  if (d.paused) {
    // Resume: set endTime = now + pausedRemaining (pausedRemaining already in ms)
    const remainingMs = Math.max(0, d.pausedRemaining || 0);
    const newEnd = Date.now() + remainingMs;
    ref.update({ endTime: newEnd, paused: false, pausedRemaining: null });
  } else {
    // Pause: compute remaining relative to endTime + bonusSeconds
    if (!d.endTime) {
      // nothing to pause
      return;
    }
    const bonusMs = (d.bonusSeconds || 0) * 1000;
    const remaining = Math.max(0, (d.endTime + bonusMs) - Date.now());
    // store remaining in pausedRemaining and clear endTime
    ref.update({ paused: true, pausedRemaining: remaining, endTime: null });
  }
}

/* --- START / RESET --- */
function startTimer() {
  const threeHours = 3 * 3600 * 1000;
  ref.update({
    endTime: Date.now() + threeHours,
    bonusSeconds: (stateCache.bonusSeconds || 0),
    paused: false,
    pausedRemaining: null
  });
}

function resetAll() {
  if (!confirm('This deletes EVERYTHING. Are you sure?')) return;
  ref.set({
    config: { milestones: {}, goal: 10000 },
    settings: {},
    theme: {},
    totalEarned: 0,
    bonusSeconds: 0,
    endTime: null,
    paused: false,
    pausedRemaining: null,
    subsCount: 0,
    bitsCount: 0
  });
}

/* --- ADD / MONEY / TIME --- */
function addMoneyAndTime() {
  const m = parseFloat(document.getElementById('addMoney').value) || 0;
  const t = parseFloat(document.getElementById('addMinutes').value) || 0;
  if (!m && !t) return alert('Enter an amount or minutes to add.');

  // atomic update via transaction
  ref.transaction(x => {
    x = x || {};
    x.totalEarned = (x.totalEarned || 0) + m;
    x.bonusSeconds = (x.bonusSeconds || 0) + Math.round(t * 60);
    // if paused, also add to pausedRemaining so it immediately affects remaining time
    if (x.paused) {
      x.pausedRemaining = (x.pausedRemaining || 0) + Math.round(t * 60) * 1000;
    }
    return x;
  });

  document.getElementById('addMoney').value = '';
  document.getElementById('addMinutes').value = '';
}

function addMoneyOnly() {
  const m = parseFloat(document.getElementById('addMoney').value) || 0;
  if (!m) return alert('Enter an amount to add.');
  ref.transaction(x => {
    x = x || {};
    x.totalEarned = (x.totalEarned || 0) + m;
    const extraSec = Math.round(m * 60); // 1 minute per dollar
    x.bonusSeconds = (x.bonusSeconds || 0) + extraSec;
    if (x.paused) x.pausedRemaining = (x.pausedRemaining || 0) + extraSec * 1000;
    return x;
  });
  document.getElementById('addMoney').value = '';
}

function addTimeOnly() {
  const t = parseFloat(document.getElementById('addMinutes').value) || 0;
  if (!t) return alert('Enter minutes to add.');
  ref.transaction(x => {
    x = x || {};
    x.bonusSeconds = (x.bonusSeconds || 0) + Math.round(t * 60);
    if (x.paused) x.pausedRemaining = (x.pausedRemaining || 0) + Math.round(t * 60) * 1000;
    return x;
  });
  document.getElementById('addMinutes').value = '';
}

/* --- NAME / THEME --- */
function updateName() {
  const v = (document.getElementById('streamerName').value || '').trim();
  ref.child('settings/streamerName').set(v || 'Ceres');
}
function saveGoalScale() {
  const scale = Number(document.getElementById('goalScale').value || 100) / 100;
  ref.child('theme/goalScale').set(scale);
}
function save(k,v) { ref.child('theme').child(k).set(v); }
function saveColors() {
  ['accent','text','grad1','grad2','goalHitColor','timerHitColor'].forEach(k=>{
    const el = document.getElementById(k);
    if (el) save(k, el.value);
  });
}
function loadTheme(t) {
  // goal scale
  if (t.goalScale) {
    const vs = Math.round(t.goalScale * 100);
    const gs = document.getElementById('goalScale');
    if (gs) { gs.value = vs; document.getElementById('scaleValue').textContent = vs; }
  }
  // checkboxes (explicit boolean)
  ['hideSubs','hideGoal','hideFooter','confettiOn'].forEach(k=>{
    const el = document.getElementById(k);
    if (!el) return;
    el.checked = !!t[k];
  });
  if (t.soundVolume !== undefined && document.getElementById('soundVol')) {
    document.getElementById('soundVol').value = t.soundVolume;
  }
}

/* --- MILESTONES --- */
function addGoal() {
  const a = parseFloat(document.getElementById('newAmt').value);
  const desc = (document.getElementById('newDesc').value || '').trim();
  if (!a || !desc) return alert('Please supply an amount and description.');
  ref.child('config/milestones').push({ amount: a, description: desc });
  document.getElementById('newAmt').value = '';
  document.getElementById('newDesc').value = '';
}

function renderGoals(snap) {
  // snap.val() may be an object map keyed by firebase push keys
  const g = (typeof snap.val === 'function') ? snap.val() : (snap || {});
  const goalList = document.getElementById('goalList');
  goalList.innerHTML = '';

  // convert to array and sort by amount
  const entries = Object.entries(g || {}).map(([id, item]) => ({ id, amount: Number(item.amount || 0), description: item.description || '' }));
  entries.sort((a,b) => a.amount - b.amount);

  entries.forEach(entry => {
    const wrapper = document.createElement('div');
    wrapper.className = 'goal-item';

    const amount = document.createElement('span');
    amount.textContent = `$${entry.amount}`;
    amount.style.minWidth = '90px';
    amount.style.fontWeight = '700';

    const input = document.createElement('input');
    input.value = entry.description;
    input.style.flex = '1';
    input.addEventListener('change', function(){
      ref.child(`config/milestones/${entry.id}/description`).set(this.value);
    });

    const del = document.createElement('button');
    del.textContent = 'Delete';
    del.style.background = '#e91e63';
    del.style.color = '#fff';
    del.addEventListener('click', function(){
      if (confirm('Delete this milestone?')) {
        ref.child(`config/milestones/${entry.id}`).remove();
      }
    });

    wrapper.appendChild(amount);
    wrapper.appendChild(input);
    wrapper.appendChild(del);
    goalList.appendChild(wrapper);
  });

  if (entries.length === 0) {
    const p = document.createElement('div');
    p.className = 'small';
    p.textContent = 'No milestones set.';
    goalList.appendChild(p);
  }
}

/* defensive: ensure renderGoals called safely if firebase gives null */
renderGoals({ val: () => ({}) });

</script>
</body>
</html>
