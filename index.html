<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ceres Donothon Overlay</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
<style>
:root {--border:#a855f7;--bg:#0d0b1c;--accent:#a855f7;--accent2:#c17aff;--text:#e2e8f0;--timerGlow:#00ffaa;--goalHit:#00ffaa;--scale:1;}
body{margin:0;padding:0;background:transparent;color:var(--text);font-family:'Exo 2',sans-serif;}
.overlay{position:fixed;bottom:0;right:0;transform:scale(var(--scale));background:var(--bg);border:4px solid var(--border);border-radius:2em;padding:2em;text-align:center;box-shadow:0 0 2em var(--border);}
#timer{font-family:'Orbitron',sans-serif;font-size:5em;text-shadow:0 0 .5em var(--timerGlow);}
.progress-bar{height:1em;border-radius:.5em;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width 1s;}
</style>
</head>
<body>
<div class="overlay">
  <div id="timer">03:00:00</div>
  <div>Raised: $<span id="raised">0.00</span></div>
  <div id="milestonesOverlay"></div>
</div>

<script>
const PATH='donothon-ultimate-2025-x7k9p2m4q8z3v6n1';
firebase.initializeApp({apiKey:"AIzaSyBFQFPo85fIpaHWl3Kr0PZ6WIm5B6WVusA",authDomain:"ceres-donothon-timer.firebaseapp.com",databaseURL:"https://ceres-donothon-timer-default-rtdb.firebaseio.com",projectId:"ceres-donothon-timer"});
const ref = firebase.database().ref(PATH);
const doneMilestones = new Set();

ref.on('value', snap=>{
  const d = snap.val()||{};
  // COLORS
  if(d.theme) Object.entries(d.theme).forEach(([k,v])=>document.documentElement.style.setProperty('--'+k,v));
});

setInterval(()=>ref.once('value').then(d=>{
  const data=d.val()||{};
  const now=Date.now();
  const bonus=(data.bonusSeconds||0)*1000;
  const base=data.paused && data.pausedAt ? data.pausedAt : (data.endTime||now+10800000);
  const left=Math.max(0,Math.floor((base+bonus-now)/1000));
  const h=('0'+Math.floor(left/3600)).slice(-2),
        m=('0'+Math.floor(left%3600/60)).slice(-2),
        s=('0'+left%60).slice(-2);
  document.getElementById('timer').textContent=`${h}:${m}:${s}`;
  document.getElementById('raised').textContent=(data.totalEarned||0).toFixed(2);
  renderGoals(data.config?.milestones||{}, data.totalEarned||0);
}),200);

function renderGoals(goals, earned){
  const container=document.getElementById('milestonesOverlay');
  container.innerHTML='';
  Object.entries(goals||{}).sort((a,b)=>a[1].amount-b[1].amount).forEach(([id,g])=>{
    const pct=Math.min(100,(earned/g.amount)*100);
    const div=document.createElement('div');
    div.style.position='relative'; div.style.margin='.5em 0';
    div.innerHTML=`<div>${g.description} $${g.amount}</div><div class="progress-bar" style="width:${pct}%"></div>`;
    if(earned>=g.amount&&!doneMilestones.has(g.amount)){
      doneMilestones.add(g.amount);
      confetti({particleCount:150,spread:180,origin:{y:.6}});
      new Audio('https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg').play();
    }
    container.appendChild(div);
  });
}
</script>
</body>
</html>
