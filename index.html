<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Donothon Timer</title>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@700&family=Orbitron:wght@900&display=swap" rel="stylesheet">
<style>
  html,body{margin:0;height:100%;background:0 0;display:flex;align-items:center;justify-content:center;font-size:1.7vw;overflow:hidden}
  :root{--a:#a855f7;--b:rgba(8,8,28,.96);--t:#fff;--g1:#a855f7;--g2:#00e5ff;--c:#00ffaa;--s:1}
  .o{background:var(--b);padding:4em;border-radius:3em;border:.35em solid var(--a);box-shadow:0 0 6em var(--a),inset 0 0 4em #a855f730;backdrop-filter:blur(1em);text-align:center;max-width:95%;transform:scale(var(--s))}
  #t{font:900 9em Orbitron,sans-serif;letter-spacing:.08em;color:var(--t);text-shadow:0 0 .5em #000;margin:0 0 1em}
  #t.p{color:#f55;text-shadow:0 0 1em #f00}
  #t.b{color:var(--c);text-shadow:0 0 1.2em #0f0}
  #t.f{animation:f 1.2s}@keyframes f{50%{text-shadow:0 0 3em #0f0;color:var(--c);transform:scale(1.15)}}
  .s{font:600 3.2em Exo 2,sans-serif;margin:.8em 0;color:var(--t)}
  .g{margin:2em 0 0;background:#1e1e46c0;border-radius:2em;padding:1.8em;border:.3em solid #333;position:relative;overflow:hidden}
  .g.c{border-color:var(--c);box-shadow:0 0 1.5em #00ffaa80;background:#004030c0}
  .g.flash{animation:flash .25s 6}
  @keyframes flash{0%,100%{box-shadow:0 0 1.5em #00ffaa80,0 0 4em #0f9}50%{box-shadow:0 0 3em #0f9,0 0 6em #0f9;background:#008040}}
  .gt{font:700 2.8em Exo 2,sans-serif;margin-bottom:.8em;color:var(--t)}
  .bar{height:4.5em;background:linear-gradient(90deg,var(--g1),var(--g2));border-radius:1.5em;transition:width 2s cubic-bezier(0.2,0.8,0.4,1)}
  .ck{position:absolute;right:3em;top:50%;transform:translateY(-50%);font-size:9em;color:var(--c);opacity:0;animation:k 1.2s .6s forwards}
  @keyframes k{0%{opacity:0;transform:translateY(-50%) scale(.3) rotate(-45deg)}70%{opacity:1;transform:translateY(-50%) scale(1.3) rotate(10deg)}100%{opacity:1;transform:translateY(-50%) scale(1)}}
  .br{margin-top:1em;font:500 2.2em Exo 2,sans-serif;color:#999}
</style>
</head>
<body>

<div class="o">
  <div id="t">03:00:00</div>
  <div class="s">Raised: $<span id="r">0.00</span> • Goal: $<span id="g">10,000</span></div>
  <div class="s">Subs: <span id="s">0</span> • Bits: <span id="b">0</span></div>
  <div id="m"></div>
  <div class="br" id="n">Donothon Timer by Ceres</div>
</div>

<audio id="rs" src="https://static.wikia.nocookie.net/runescape/images/4/4f/Level_up.ogg/revision/latest?cb=20200101000000" preload="auto"></audio>

<script>
// ==== CONFIG ==== (replace with your own project if you fork this)
const firebaseConfig = {
  apiKey: "AIzaSyBFQFPo85fIpaHWl3Kr0PZ6WIm5B6WVusA",
  authDomain: "ceres-donothon-timer.firebaseapp.com",
  databaseURL: "https://ceres-donothon-timer-default-rtdb.firebaseio.com",
  projectId: "ceres-donothon-timer"
};
const PATH = 'donothon-ultimate-2025-x7k9p2m4q8z3v6n1'; // change if you make a new event

firebase.initializeApp(firebaseConfig);
const db = firebase.database().ref(PATH);
const sound = document.getElementById('rs');

// Persistent celebrated goals (so refresh still celebrates)
const doneGoals = new Set(JSON.parse(localStorage.getItem('donothon-done') || '[]'));
let latestEarned = 0;
let cache = {};

// Theme & streamer name
db.child('theme').on('value', s => {
  const t = s.val() || {};
  Object.entries(t).forEach(([k, v]) => v && document.documentElement.style.setProperty('--' + k, v));
  document.documentElement.style.setProperty('--s', t.goalScale || 1);
});
db.child('settings').on('value', s => {
  const val = s.val() || {};
  document.getElementById('n').textContent = val.streamerName || "Donothon Timer by Ceres";
});

// Main data listener
db.on('value', snap => {
  cache = snap.val() || {};
  updateDisplay();
});

// Timer-only tick (smooth seconds)
setInterval(() => {
  if (cache.endTime !== undefined) updateTimerOnly();
}, 200);

function updateDisplay() {
  const d = cache;
  const cfg = d.config || {};
  const earned = +d.totalEarned || 0;
  const goals = Object.values(cfg.milestones || {}).sort((a, b) => a.amount - b.amount);

  // === Stats ===
  document.getElementById('r').textContent = earned.toFixed(2);
  document.getElementById('g').textContent = (cfg.goal || 10000).toLocaleString();
  document.getElementById('s').textContent = d.subsCount || 0;
  document.getElementById('b').textContent = d.bitsCount || 0;

  // === Goals rendering ===
  const container = document.getElementById('m');
  container.innerHTML = '';

  // Show next 3 upcoming + any already completed within +5k
  const visible = goals.filter(g => earned < g.amount + 5000).slice(0, 3);

  visible.forEach(goal => {
    const complete = earned >= goal.amount;
    const pct = complete ? 100 : (earned / goal.amount) * 100;

    const div = document.createElement('div');
    div.className = `g${complete ? ' c' : ''}`;

    if (complete && !doneGoals.has(goal.amount)) {
      doneGoals.add(goal.amount);
      localStorage.setItem('donothon-done', JSON.stringify([...doneGoals]));

      // Celebration!
      div.classList.add('flash');
      setTimeout(() => div.classList.remove('flash'), 1600);
      confetti({ particleCount: 600, spread: 160, origin: { y: 0.6 }, scalar: 1.2 });
      sound.currentTime = 0;
      sound.play().catch(() => {}); // browsers block autoplay sometimes
    }

    div.innerHTML = `
      <div class="gt">$${goal.amount.toLocaleString()} → ${goal.description || 'Goal'}</div>
      <div style="position:relative">
        <div class="bar" style="width:${pct}%"></div>
        ${complete ? '<div class="ck">Checkmark</div>' : ''}
      </div>`;
    container.appendChild(div);
  });

  latestEarned = earned;
  updateTimerOnly(); // also refresh timer
}

function updateTimerOnly() {
  const d = cache;
  if (!d) return;

  const end = d.endTime || Date.now() + 3 * 3600 * 1000;
  const bonus = +d.bonusSeconds || 0;
  const paused = !!d.paused;
  const now = Date.now();

  let left = paused && d.pausedAt
    ? Math.floor((d.pausedAt + bonus * 1000 - now) / 1000)
    : Math.floor((end + bonus * 1000 - now) / 1000);
  left = Math.max(0, left);

  const h = ('0' + Math.floor(left / 3600)).slice(-2);
  const m = ('0' + Math.floor(left % 3600 / 60)).slice(-2);
  const s = ('0' + (left % 60)).slice(-2);

  const t = document.getElementById('t');
  t.textContent = `${h}:${m}:${s}`;
  t.className = '';
  if (bonus > 0) t.classList.add('b');
  if (paused) t.classList.add('p');
}

// Initial load
updateDisplay();
</script>
</body>
</html>
