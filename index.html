<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ceres Donothon 2025 — COUNTDOWN + BITS + HYPE TRAIN</title>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
<style>
  :root{--accent:#9146FF;--bg:rgba(0,0,0,0.8);--text:white;--grad1:#9146FF;--grad2:#00ffcc;--check:#00ff99}
  body{margin:0;background:transparent;font-family:'Impact',sans-serif;color:var(--text);text-align:center}
  .container{padding:40px;border-radius:30px;display:inline-block;background:var(--bg);border:6px solid var(--accent);box-shadow:0 0 60px var(--accent)}
  #timer{font-size:140px;letter-spacing:10px;text-shadow:0 0 30px #000;margin:20px 0;transition:all 0.6s}
  .timer-bonus{color:#00ff00 !important;text-shadow:0 0 50px #0f0 !important;transform:scale(1.05)}
  .stats{font-size:60px;margin:15px 0}
  .goal-row{background:#222;border-radius:20px;padding:20px;margin:30px 0;position:relative;overflow:hidden;border:4px solid #444;transition:all 1s}
  .goal-row.complete{border-color:var(--check);background:rgba(0,100,0,0.8)}
  .goal-row.hiding{opacity:0;transform:translateY(-50px);height:0;padding:0;margin:0;border:none}
  .bar-fill{height:70px;background:linear-gradient(90deg,var(--grad1),var(--grad2));border-radius:15px;transition:width 1.5s ease}
  .checkmark{position:absolute;right:30px;top:50%;transform:translateY(-50%);font-size:110px;color:var(--check);opacity:0;transition:opacity 1s}
  .checkmark.show{opacity:1}
  .token-info{position:fixed;bottom:10px;left:10px;background:rgba(0,0,0,0.7);padding:10px;border-radius:10px;font-size:14px;color:#0f0}
</style>
</head>
<body>
<div class="container">
  <div id="timer">00:00:00</div>
  <div class="stats">Raised: $<span id="raised">0.00</span> / $<span id="goal">10,000</span></div>
  <div class="stats">Subs: <span id="subs">0</span> | Bits: <span id="bits">0</span></div>
  <div id="goals"></div>
</div>
<div class="token-info" id="tokenInfo">Read-only — Add ?token=… to add time!</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBFQFPo85fIpaHWl3Kr0PZ6WIm5B6WVusA",
  authDomain: "ceres-donothon-timer.firebaseapp.com",
  databaseURL: "https://ceres-donothon-timer-default-rtdb.firebaseio.com",
  projectId: "ceres-donothon-timer",
  storageBucket: "ceres-donothon-timer.firebasestorage.app",
  messagingSenderId: "62539165670",
  appId: "1:62539165670:web:170c8110449deba628b027",
  measurementId: "G-9F66NMVB2J"
};
const PATH = 'donothon-ultimate-2025-x7k9p2m4q8z3v6n1';

firebase.initializeApp(firebaseConfig);
const db = firebase.database().ref(PATH);

const params = new URLSearchParams(location.search);
const token = params.get('token') || params.get('sl') || params.get('se') || '';
if (token) document.getElementById('tokenInfo').textContent = 'CONNECTED — all events add time!';

db.child('theme').on('value', s => {
  const t = s.val()||{};
  Object.entries(t).forEach(([k,v]) => v && document.documentElement.style.setProperty('--'+k,v));
});

let earned = 0, completed = new Set();

// MAIN TIMER + DISPLAY
db.on('value', s => {
  const d = s.val()||{};
  const c = d.config||{};
  earned = Number(d.totalEarned)||0;

  // Countdown + bonus time
  const baseEndTime = d.endTime || (Date.now() + 24*60*60*1000);
  const bonusSeconds = Number(d.bonusSeconds)||0;
  const totalSecondsLeft = Math.max(0, Math.floor((baseEndTime + bonusSeconds*1000 - Date.now())/1000));

  const h = String(Math.floor(totalSecondsLeft/3600)).padStart(2,'0');
  const m = String(Math.floor(totalSecondsLeft%3600/60)).padStart(2,'0');
  const sec = String(totalSecondsLeft%60).padStart(2,'0');

  const timerEl = document.getElementById('timer');
  timerEl.textContent = `${h}:${m}:${sec}`;
  timerEl.classList.toggle('timer-bonus', bonusSeconds > 0);

  document.getElementById('raised').textContent = earned.toFixed(2);
  document.getElementById('goal').textContent = c.goal||10000;
  document.getElementById('subs').textContent = d.subsCount||0;
  document.getElementById('bits').textContent = d.bitsCount||0;

  // Goals rendering
  const container = document.getElementById('goals');
  container.innerHTML = '';
  const goals = Object.values(c.milestones||{}).sort((a,b)=>a.amount-b.amount);
  const active = goals.filter(g=>earned < g.amount+5000).slice(0,3);

  active.forEach(g => {
    const complete = earned >= g.amount;
    const pct = Math.min(100, (earned/g.amount)*100);
    const row = document.createElement('div');
    row.className = `goal-row ${complete?'complete':''}`;
    row.dataset.id = g.amount;
    row.innerHTML = `
      <div style="font-size:48px;margin-bottom:15px;">$${g.amount.toLocaleString()} → ${g.description||''}</div>
      <div style="position:relative;">
        <div class="bar-fill" style="width:${pct}%"></div>
        <div class="checkmark ${complete?'show':''}">CHECKMARK</div>
      </div>
    `;
    if (complete && !completed.has(g.amount)) {
      completed.add(g.amount);
      confetti({particleCount:600, spread:160, origin:{y:0.55}});
    }
    container.appendChild(row);
  });
});

// ALL EVENTS ADD TIME — INCLUDING BITS & HYPE TRAIN
if (token) {
  const isSE = token.length > 50;
  const socket = isSE 
    ? io('wss://realtime.streamelements.com', {transports:['websocket']})
    : io('https://sockets.streamlabs.com', {query:{token}, transports:['websocket']});

  if (isSE) socket.on('connect', () => socket.emit('authenticate', {method:'jwt', token}));

  socket.on('event', e => {
    if (!e?.type) return;
    const msgs = Array.isArray(e.message) ? e.message : [e.message||{}];

    db.transaction(data => {
      if (!data) data = {bonusSeconds:0, totalEarned:0, subsCount:0, bitsCount:0};
      if (!data.endTime) data.endTime = Date.now() + 24*60*60*1000;

      msgs.forEach(m => {
        // Donations / Tips
        if (e.type.includes('donation') || e.type.includes('tip')) {
          const amt = parseFloat(m.amount || m.formatted_amount || 0);
          if (amt>0) {
            data.totalEarned += amt;
            data.bonusSeconds += Math.floor(amt * 60); // $1 = 1 minute
          }
        }

        // Subscriptions
        if (e.type.includes('subscription') || e.type.includes('subscriber') || e.type === 'resub') {
          const cnt = m.count || 1;
          data.subsCount = (data.subsCount||0) + cnt;
          const tierPrice = m.sub_plan === '3000' ? 24.99 : m.sub_plan === '2000' ? 9.99 : 4.99;
          data.totalEarned += tierPrice * cnt;
          data.bonusSeconds += 300 * cnt; // +5 minutes per sub
        }

        // Bits / Cheers
        if (e.type.includes('bits') || e.type.includes('cheer')) {
          const bits = parseInt(m.amount || 0);
          if (bits > 0) {
            data.bitsCount = (data.bitsCount||0) + bits;
            data.totalEarned += bits * 0.01;
            data.bonusSeconds += Math.floor(bits / 100) * 60; // 100 bits = 1 minute
          }
        }

        // Hype Train (Streamlabs & StreamElements both send this)
        if (e.type === 'hypetrain_start' || e.type === 'hypetrain_level_up') {
          const level = e.level || 1;
          data.bonusSeconds += level * 300; // +5 minutes per level
          confetti({particleCount:800, spread:180, origin:{y:0.4}});
        }
      });
      return data;
    });
  });
}
</script>
</body>
</html>
