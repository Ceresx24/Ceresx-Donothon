<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Donothon Timer</title>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@500;700;900&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">

<style>
  html,body{margin:0;padding:0;height:100%;width:100%;overflow:hidden;background:transparent;display:flex;align-items:center;justify-content:center}
  :root{
    --accent:#a855f7;--bg:rgba(8,8,28,0.96);--text:#ffffff;--grad1:#a855f7;--grad2:#00e5ff;--check:#00ffaa;
    --timer:16vw;--stats:5.5vw;--goal:4.8vw;--bar:7.8vw;--pad:6vw;--space:4vw;--radius:4.5vw;--glow:10vw;
    --goal-scale:1;--font-timer:'Orbitron',sans-serif;--font-main:'Exo 2',sans-serif
  }
  .overlay{
    background:var(--bg);padding:var(--pad);border-radius:var(--radius);border:0.45vw solid var(--accent);
    box-shadow:0 0 var(--glow) var(--accent),inset 0 0 6vw rgba(168,85,247,0.2);
    backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);text-align:center;max-width:94%
  }
  #timer{font-family:var(--font-timer);font-size:var(--timer);font-weight:900;letter-spacing:0.8vw;color:var(--text);text-shadow:0 0 5vw #000;margin:0 0 2vw 0;transition:all .7s}
  #timer.paused{color:#ff5555 !important;text-shadow:0 0 7vw #f00 !important}
  #timer.bonus{color:#00ffaa !important;text-shadow:0 0 8vw #0f0 !important}
  #timer.goal-flash{animation:goalFlash 1.2s ease-out}
  @keyframes goalFlash{0%,100%{text-shadow:0 0 5vw #000}50%{text-shadow:0 0 12vw #0f0,0 0 20vw #0f0;color:#00ffaa;transform:scale(1.15)}}
  .stats{font-family:var(--font-main);font-size:var(--stats);margin:1.4vw 0;color:var(--text);font-weight:600;opacity:0.95}
  #goals{margin:var(--space) 0;transform:scale(var(--goal-scale));transform-origin:center;transition:transform 0.6s ease}
  .goal{background:rgba(30,30,70,0.75);border-radius:3vw;padding:2.5vw;margin:3.5vw 0;border:0.4vw solid #333;overflow:hidden;position:relative;transition:all 1.3s;backdrop-filter:blur(4px)}
  .goal.complete{border-color:var(--check);box-shadow:0 0 6vw #00ffaa80;background:rgba(0,70,50,0.8);animation:goalComplete 1.5s ease-out}
  @keyframes goalComplete{0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)}}
  .goal-text{font-family:var(--font-main);font-size:var(--goal);font-weight:700;margin-bottom:1.3vw;color:var(--text)}
  .bar{height:var(--bar);background:linear-gradient(90deg,var(--grad1),var(--grad2));border-radius:2vw;transition:width 2.2s ease}
  .checkmark{position:absolute;right:4vw;top:50%;transform:translateY(-50%);font-size:14vw;color:var(--check);opacity:0;animation:checkmarkAppear 1.2s 0.6s forwards}
  @keyframes checkmarkAppear{0%{opacity:0;transform:translateY(-50%) scale(0.3) rotate(-45deg)}70%{opacity:1;transform:translateY(-50%) scale(1.3) rotate(10deg)}100%{opacity:1;transform:translateY(-50%) scale(1)}}
  .branding{margin-top:5vw;font-family:var(--font-main);font-size:3.6vw;color:#999;font-weight:500;letter-spacing:0.3vw}
</style>
</head>
<body>
<div class="overlay">
  <div id="timer">03:00:00</div>
  <div class="stats">Raised: $<span id="raised">0.00</span> • Goal: $<span id="goal">10,000</span></div>
  <div class="stats">Subs: <span id="subs">0</span> • Bits: <span id="bits">0</span></div>
  <div id="goals"></div>
  <div class="branding" id="branding">Donothon Timer by Ceres</div>
</div>

<script>
const firebaseConfig = {apiKey:"AIzaSyBFQFPo85fIpaHWl3Kr0PZ6WIm5B6WVusA",authDomain:"ceres-donothon-timer.firebaseapp.com",databaseURL:"https://ceres-donothon-timer-default-rtdb.firebaseio.com",projectId:"ceres-donothon-timer",storageBucket:"ceres-donothon-timer.firebasestorage.app",messagingSenderId:"62539165670",appId:"1:62539165670:web:170c8110449deba628b027"};
const PATH = 'donothon-ultimate-2025-x7k9p2m4q8z3v6n1';
firebase.initializeApp(firebaseConfig);
const db = firebase.database().ref(PATH);

let earned = 0;
const completed = new Set();

// Theme + Settings + Goal Scale
db.child('theme').on('value', s => {
  const t = s.val() || {};
  Object.entries(t).forEach(([k,v]) => v && document.documentElement.style.setProperty('--'+k, v));
  document.documentElement.style.setProperty('--goal-scale', t.goalScale || 1);
});
db.child('settings').on('value', s => {
  const st = s.val() || {};
  document.getElementById('branding').textContent = st.streamerName || 'Donothon Timer by Ceres';
});

// Ultra-smooth update every 500ms
function update() {
  db.once('value').then(s => {
    const d = s.val() || {};
    const c = d.config || {};
    const newEarned = Number(d.totalEarned) || 0;

    // Flash timer green + confetti on new goal
    const goals = Object.values(c.milestones||{}).sort((a,b)=>a.amount-b.amount);
    const newGoal = goals.find(g => earned < g.amount && newEarned >= g.amount);
    if (newGoal) {
      document.getElementById('timer').classList.add('goal-flash');
      setTimeout(() => document.getElementById('timer').classList.remove('goal-flash'), 1500);
      confetti({particleCount:1000, spread:180, origin:{y:0.55}});
    }
    earned = newEarned;

    // Timer
    const baseEnd = d.endTime || (Date.now() + 3*60*60*1000);
    const bonus = Number(d.bonusSeconds) || 0;
    const paused = !!d.paused;
    const now = Date.now();
    let left = paused && d.pausedAt ? Math.floor((d.pausedAt + bonus*1000 - now)/1000) : Math.floor((baseEnd + bonus*1000 - now)/1000);
    left = Math.max(0, left);
    const h = String(Math.floor(left/3600)).padStart(2,'0');
    const m = String(Math.floor(left%3600/60)).padStart(2,'0');
    const sec = String(left%60).padStart(2,'0');
    document.getElementById('timer').textContent = `${h}:${m}:${sec}`;
    document.getElementById('timer').classList.toggle('bonus', bonus > 0);
    document.getElementById('timer').classList.toggle('paused', paused);

    document.getElementById('raised').textContent = earned.toFixed(2);
    document.getElementById('goal').textContent = (c.goal||10000).toLocaleString();
    document.getElementById('subs').textContent = d.subsCount||0;
    document.getElementById('bits').textContent = d.bitsCount||0;

    // Goals
    const container = document.getElementById('goals');
    container.innerHTML = '';
    goals.filter(g=>earned < g.amount + 5000).slice(0,3).forEach(g => {
      const complete = earned >= g.amount;
      const pct = Math.min(100, (earned/g.amount)*100);
      const row = document.createElement('div');
      row.className = `goal ${complete?'complete':''}`;
      row.innerHTML = `<div class="goal-text">$${g.amount.toLocaleString()} → ${g.description||'Goal'}</div>
        <div style="position:relative"><div class="bar" style="width:${pct}%"></div>${complete?'<div class="checkmark">CHECKMARK</div>':''}</div>`;
      container.appendChild(row);
    });
  });
}
setInterval(update, 500);
update();
</script>
</body>
</html>
